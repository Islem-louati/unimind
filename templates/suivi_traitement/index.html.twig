{% extends 'base_psychologue.html.twig' %}

{% block title %}Gestion des SuiviTraitements{% endblock %}
{% block page_title %}Gestion des SuiviTraitements{% endblock %}

{% block breadcrumb_title %}SuiviTraitement{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-calendar-check me-2"></i>
                                Gestion des SuiviTraitements
                            </h6>
                        </div>
                        <div class="col-auto">
                            {% if is_granted('ROLE_PSYCHOLOGUE') and not is_granted('ROLE_ADMIN') %}
                            <a href="{{ path('app_dashboard') }}" class="btn btn-info btn-sm me-2">
                                <i class="fas fa-chart-line me-1"></i>
                                Dashboard
                            </a>
                            <a href="{{ path('app_suivi_traitement_select_patient') }}" class="btn btn-primary btn-sm me-2">
                                <i class="fas fa-plus me-1"></i>
                                Nouveau Suivi
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
<!-- Statistiques Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-xl-0 mb-4">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col-10">
                        <h5 class="card-title text-uppercase text-muted mb-0">Total Suivis</h5>
                        <span class="h2 font-weight-bold mb-0">{{ stats.total }}</span>
                    </div>
                    <div class="col-2 text-center">
                        <i class="fas fa-calendar-check text-primary" style="font-size: 1.5rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-xl-0 mb-4">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col-10">
                        <h5 class="card-title text-uppercase text-muted mb-0">Effectués</h5>
                        <span class="h2 font-weight-bold mb-0">{{ stats.effectues }}</span>
                    </div>
                    <div class="col-2 text-center">
                        <i class="fas fa-check-double text-success" style="font-size: 1.5rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-xl-0 mb-4">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col-10">
                        <h5 class="card-title text-uppercase text-muted mb-0">En Attente</h5>
                        <span class="h2 font-weight-bold mb-0">{{ stats.en_attente }}</span>
                    </div>
                    <div class="col-2 text-center">
                        <i class="fas fa-hourglass-half text-warning" style="font-size: 1.5rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-xl-0 mb-4">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col-10">
                        <h5 class="card-title text-uppercase text-muted mb-0">Validés</h5>
                        <span class="h2 font-weight-bold mb-0">{{ stats.valides }}</span>
                    </div>
                    <div class="col-2 text-center">
                        <i class="fas fa-shield-alt text-info" style="font-size: 1.5rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtres et Recherche -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header pb-0">
                <div class="row">
                    <div class="col-md-4">
                        <form method="GET" action="{{ path('app_suivi_traitement_index') }}">
                            <div class="input-group">
                                <span class="input-group-text text-body"><i class="fas fa-search" aria-hidden="true"></i></span>
                                <input type="text" name="search" class="form-control" placeholder="Rechercher un suivi..." value="{{ filters.search }}">
                                <input type="hidden" name="sort" value="{{ sort }}">
                                <input type="hidden" name="order" value="{{ order }}">
                                <button type="submit" class="btn btn-outline-primary">Rechercher</button>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-2">
                        <form method="GET" action="{{ path('app_suivi_traitement_index') }}">
                            <select name="statut" class="form-select" onchange="this.form.submit()">
                                <option value="">Tous les statuts</option>
                                <option value="effectue" {% if filters.statut == 'effectue' %}selected{% endif %}>Effectué</option>
                                <option value="non_effectue" {% if filters.statut == 'non_effectue' %}selected{% endif %}>Non effectué</option>
                                <option value="valide" {% if filters.statut == 'valide' %}selected{% endif %}>Validé</option>
                                <option value="non_valide" {% if filters.statut == 'non_valide' %}selected{% endif %}>Non validé</option>
                            </select>
                            <input type="hidden" name="sort" value="{{ sort }}">
                            <input type="hidden" name="order" value="{{ order }}">
                            <input type="hidden" name="search" value="{{ filters.search }}">
                            <input type="hidden" name="ressenti" value="{{ filters.ressenti }}">
                            <input type="hidden" name="date" value="{{ filters.date }}">
                        </form>
                    </div>
                    <div class="col-md-2">
                        <form method="GET" action="{{ path('app_suivi_traitement_index') }}">
                            <select name="ressenti" class="form-select" onchange="this.form.submit()">
                                <option value="">Tous les ressentis</option>
                                {% for ressenti_value in ['très_bien', 'bien', 'neutre', 'difficile', 'très_difficile'] %}
                                    <option value="{{ ressenti_value }}" {% if filters.ressenti == ressenti_value %}selected{% endif %}>
                                        {{ ressenti_value|capitalize }}
                                    </option>
                                {% endfor %}
                            </select>
                            <input type="hidden" name="sort" value="{{ sort }}">
                            <input type="hidden" name="order" value="{{ order }}">
                            <input type="hidden" name="search" value="{{ filters.search }}">
                            <input type="hidden" name="statut" value="{{ filters.statut }}">
                            <input type="hidden" name="date" value="{{ filters.date }}">
                        </form>
                    </div>
                    <div class="col-md-2">
                        <form method="GET" action="{{ path('app_suivi_traitement_index') }}">
                            <input type="date" name="date" class="form-control" onchange="this.form.submit()" value="{{ filters.date }}">
                            <input type="hidden" name="sort" value="{{ sort }}">
                            <input type="hidden" name="order" value="{{ order }}">
                            <input type="hidden" name="search" value="{{ filters.search }}">
                            <input type="hidden" name="statut" value="{{ filters.statut }}">
                            <input type="hidden" name="ressenti" value="{{ filters.ressenti }}">
                        </form>
                    </div>
                    <div class="col-md-2">
                        <a href="{{ path('app_suivi_traitement_index') }}" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-redo me-1"></i>Réinitialiser
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Liste des Suivis -->
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Liste des SuiviTraitements</h6>
                <div>
                    {% if is_granted('ROLE_PSYCHOLOGUE') or is_granted('ROLE_ETUDIANT') %}
                    {% if is_granted('ROLE_PSYCHOLOGUE') and not is_granted('ROLE_ADMIN') %}
                        <a href="{{ path('app_suivi_traitement_select_patient') }}" class="btn btn-primary btn-sm me-2">
                            <i class="fas fa-plus me-2"></i>Nouveau Suivi
                        </a>
                    {% endif %}
                {% endif %}
                <a href="{{ path('app_traitement_index') }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-stethoscope me-2"></i>Traitements
                </a>
            </div>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
                {% if suivis|length > 0 %}
                    <div class="table-responsive p-0">
                        <table class="table align-items-center mb-0">
                            <thead>
                                <tr>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                        <a href="{{ path('app_suivi_traitement_index', {sort: 'date', order: sort == 'date' and order == 'asc' ? 'desc' : 'asc'}) }}" class="text-decoration-none text-secondary">
                                            Date 
                                            {% if sort == 'date' %}
                                                {% if order == 'asc' %}↑{% else %}↓{% endif %}
                                            {% else %}
                                                ↕
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                        <a href="{{ path('app_suivi_traitement_index', {sort: 'traitement', order: sort == 'traitement' and order == 'asc' ? 'desc' : 'asc'}) }}" class="text-decoration-none text-secondary">
                                            Traitement
                                            {% if sort == 'traitement' %}
                                                {% if order == 'asc' %}↑{% else %}↓{% endif %}
                                            {% else %}
                                                ↕
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                        <a href="{{ path('app_suivi_traitement_index', {sort: 'patient', order: sort == 'patient' and order == 'asc' ? 'desc' : 'asc'}) }}" class="text-decoration-none text-secondary">
                                            Patient
                                            {% if sort == 'patient' %}
                                                {% if order == 'asc' %}↑{% else %}↓{% endif %}
                                            {% else %}
                                                ↕
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                        <a href="{{ path('app_suivi_traitement_index', {sort: 'ressenti', order: sort == 'ressenti' and order == 'asc' ? 'desc' : 'asc'}) }}" class="text-decoration-none text-secondary">
                                            Ressenti
                                            {% if sort == 'ressenti' %}
                                                {% if order == 'asc' %}↑{% else %}↓{% endif %}
                                            {% else %}
                                                ↕
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                        <a href="{{ path('app_suivi_traitement_index', {sort: 'evaluation', order: sort == 'evaluation' and order == 'asc' ? 'desc' : 'asc'}) }}" class="text-decoration-none text-secondary">
                                            Évaluation
                                            {% if sort == 'evaluation' %}
                                                {% if order == 'asc' %}↑{% else %}↓{% endif %}
                                            {% else %}
                                                ↕
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                        <a href="{{ path('app_suivi_traitement_index', {sort: 'statut', order: sort == 'statut' and order == 'asc' ? 'desc' : 'asc'}) }}" class="text-decoration-none text-secondary">
                                            Statut
                                            {% if sort == 'statut' %}
                                                {% if order == 'asc' %}↑{% else %}↓{% endif %}
                                            {% else %}
                                                ↕
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Observations</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set current_patient = null %}
                                {% set current_traitement = null %}
                                
                                {% for suivi in suivis %}
                                    {% set patient_key = suivi.traitement.etudiant ? suivi.traitement.etudiant.getUserId() : 'no_patient' %}
                                    {% set traitement_key = suivi.traitement.getTraitementId() %}
                                    
                                    <!-- Ligne de séparation patient -->
                                    {% if current_patient != patient_key %}
                                        {% if current_patient is not null %}
                                            <tr>
                                                <td colspan="8" class="bg-light text-center fw-bold py-2">
                                                    <hr class="my-0">
                                                </td>
                                            </tr>
                                        {% endif %}
                                        {% set current_patient = patient_key %}
                                        {% set current_traitement = null %}
                                        
                                        <tr class="patient-header">
                                            <td colspan="8" class="bg-gradient-info text-white fw-bold py-2">
                                                <i class="fas fa-user me-2"></i>
                                                {% if suivi.traitement.etudiant %}
                                                    {{ suivi.traitement.etudiant.fullName }}
                                                    <small class="ms-2 opacity-75">{{ suivi.traitement.etudiant.email }}</small>
                                                {% else %}
                                                    Patient non assigné
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                    
                                    <!-- Ligne de séparation traitement -->
                                    {% if current_traitement != traitement_key %}
                                        {% if current_traitement is not null %}
                                            <tr>
                                                <td colspan="8" class="bg-light">
                                                    <small class="text-muted">─────────────────────────────────</small>
                                                </td>
                                            </tr>
                                        {% endif %}
                                        {% set current_traitement = traitement_key %}
                                        
                                        <tr class="traitement-header">
                                            <td colspan="8" class="bg-light border p-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-0 text-primary">
                                                            <i class="fas fa-stethoscope me-2"></i>
                                                            {{ suivi.traitement.titre }}
                                                        </h6>
                                                        <small class="text-muted">
                                                            {{ suivi.traitement.categorieLabel }} | 
                                                            Statut: {{ suivi.traitement.statutLabel }}
                                                        </small>
                                                    </div>
                                                    <div>
                                                        {% if is_granted('ROLE_PSYCHOLOGUE') %}
                                                            <a href="{{ path('app_traitement_show', {'id': suivi.traitement.getTraitementId()}) }}" class="btn btn-sm btn-outline-primary" title="Voir le traitement">
                                                                <i class="fas fa-eye"></i>
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                    
                                    <!-- Ligne de suivi -->
                                    <tr class="suivi-row">
                                        <td>
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="mb-0 text-sm">{{ suivi.dateSuivi|date('d/m/Y') }}</h6>
                                                <p class="text-xs text-secondary mb-0">{{ suivi.heureEffective ? suivi.heureEffective|date('H:i') : 'N/A' }}</p>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="mb-0 text-sm">{{ suivi.traitement.titre }}</h6>
                                                <p class="text-xs text-secondary mb-0">{{ suivi.traitement.categorieLabel }}</p>
                                            </div>
                                        </td>
                                        <td>
                                            <p class="text-xs font-weight-bold mb-0">{{ suivi.traitement.etudiant ? suivi.traitement.etudiant.fullName : 'Non défini' }}</p>
                                            <p class="text-xs text-secondary mb-0">
                                                <i class="fas fa-user-md me-1"></i>
                                                {{ suivi.traitement.psychologue ? suivi.traitement.psychologue.fullName : 'Non défini' }}
                                            </p>
                                        </td>
                                        <td>
                                            {% if suivi.ressenti %}
                                                <span class="badge {% if suivi.ressenti|lower == 'très_bien' %}bg-gradient-success{% elseif suivi.ressenti|lower == 'bien' %}bg-gradient-info{% elseif suivi.ressenti|lower == 'neutre' %}bg-gradient-warning{% else %}bg-gradient-danger{% endif %}">
                                                    {{ suivi.ressenti }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if suivi.evaluation %}
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">{{ suivi.evaluation }}/5</span>
                                                    <div class="progress" style="width: 60px; height: 6px;">
                                                        <div class="progress-bar bg-gradient-info" style="width: {{ (suivi.evaluation / 5) * 100 }}%"></div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                {% if suivi.effectue %}
                                                    <span class="badge bg-gradient-success mb-1">Effectué</span>
                                                {% else %}
                                                    <span class="badge bg-gradient-warning mb-1">En attente</span>
                                                {% endif %}
                                                
                                                {% if suivi.valide %}
                                                    <span class="badge bg-gradient-info">Validé</span>
                                                {% else %}
                                                    <span class="badge bg-gradient-secondary">Non validé</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 150px;" title="{{ is_granted('ROLE_ETUDIANT') ? suivi.observations : suivi.observationsPsy }}">
                                                {% if is_granted('ROLE_ETUDIANT') %}
                                                    {{ suivi.observations|slice(0, 30) }}{% if suivi.observations|length > 30 %}...{% endif %}
                                                {% else %}
                                                    {{ suivi.observationsPsy|slice(0, 30) }}{% if suivi.observationsPsy|length > 30 %}...{% endif %}
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="align-middle text-center">
                                            <div class="d-flex gap-2 justify-content-center">
                                                <a href="{{ path('app_suivi_traitement_show', {'id': suivi.id}) }}" class="btn btn-sm btn-info" title="Voir">
                                                    <i class="fas fa-eye me-1"></i>Voir
                                                </a>
                                                {% if is_granted('ROLE_PSYCHOLOGUE') and not is_granted('ROLE_ADMIN') and suivi.traitement.psychologue == app.user %}
                                                    <a href="{{ path('ai_analyze_suivi', {'id': suivi.id}) }}" class="btn btn-sm btn-success" title="Analyse IA">
                                                        <i class="fas fa-brain me-1"></i>IA
                                                    </a>
                                                    <a href="{{ path('app_suivi_traitement_edit', {'id': suivi.id}) }}" class="btn btn-sm btn-warning" title="Modifier">
                                                        <i class="fas fa-edit me-1"></i>Modifier
                                                    </a>
                                                    <form method="post" action="{{ path('app_suivi_traitement_delete', {'id': suivi.id}) }}" style="display: inline;" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce suivi ?');">
                                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ suivi.id) }}">
                                                        <button type="submit" class="btn btn-sm btn-danger" title="Supprimer">
                                                            <i class="fas fa-trash me-1"></i>Supprimer
                                                        </button>
                                                    </form>
                                                {% endif %}
                                                {% if is_granted('ROLE_ETUDIANT') and not is_granted('ROLE_ADMIN') and suivi.traitement.etudiant == app.user %}
                                                    <a href="{{ path('ai_analyze_suivi', {'id': suivi.id}) }}" class="btn btn-sm btn-success" title="Analyse IA">
                                                        <i class="fas fa-brain me-1"></i>IA
                                                    </a>
                                                    <a href="{{ path('app_suivi_traitement_edit', {'id': suivi.id}) }}" class="btn btn-sm btn-warning" title="Modifier">
                                                        <i class="fas fa-edit me-1"></i>Modifier
                                                    </a>
                                                    <form method="post" action="{{ path('app_suivi_traitement_delete', {'id': suivi.id}) }}" style="display: inline;" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce suivi ?');">
                                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ suivi.id) }}">
                                                        <button type="submit" class="btn btn-sm btn-danger" title="Supprimer">
                                                            <i class="fas fa-trash me-1"></i>Supprimer
                                                        </button>
                                                    </form>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <!-- Message si aucun suivi -->
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-heart fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Aucun suivi trouvé</h5>
                        <p class="text-muted">Commencez par créer un nouveau suivi thérapeutique</p>
                        {% if is_granted('ROLE_PSYCHOLOGUE') and not is_granted('ROLE_ADMIN') %}
                            <a href="{{ path('app_suivi_traitement_select_patient') }}" class="btn btn-primary btn-lg me-2">
                                <i class="fas fa-plus me-2"></i>Nouveau Suivi
                            </a>
                        {% elseif is_granted('ROLE_ETUDIANT') %}
                            <a href="{{ path('app_suivi_traitement_select_traitement') }}" class="btn btn-primary btn-lg me-2">
                                <i class="fas fa-plus me-2"></i>Nouveau Suivi
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-center">
                {{ knp_pagination_render(suivis, 'pagination/custom_pagination.html.twig') }}
            </div>
        </div>
    </div>
</div>
{% endblock %}