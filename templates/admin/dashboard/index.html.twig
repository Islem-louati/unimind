{% extends 'base1.html.twig' %}

{% block title %}Dashboard Méditation{% endblock %}

{% block breadcrumb_current %}Dashboard{% endblock %}

{% block page_title %}Dashboard Méditation{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  
  {# KPI - Statistiques principales #}
  <div class="row">
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-uppercase font-weight-bold">Total Catégories</p>
                <h5 class="font-weight-bolder mb-0">
                  {{ total_categories }}
                </h5>
                <p class="mb-0">
                  <span class="text-success text-sm font-weight-bolder">+{{ categories_ce_mois }}</span>
                  ce mois
                </p>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                <i class="fas fa-layer-group text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-uppercase font-weight-bold">Total Séances</p>
                <h5 class="font-weight-bolder mb-0">
                  {{ total_seances }}
                </h5>
                <p class="mb-0">
                  <span class="text-success text-sm font-weight-bolder">+{{ seances_ce_mois }}</span>
                  ce mois
                </p>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle">
                <i class="fas fa-music text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-uppercase font-weight-bold">Séances Actives</p>
                <h5 class="font-weight-bolder mb-0">
                  {{ seances_actives }}
                </h5>
                <p class="mb-0">
                  <span class="text-success text-sm font-weight-bolder">{{ pourcentage_actives }}%</span>
                  du total
                </p>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-info shadow-info text-center rounded-circle">
                <i class="fas fa-play-circle text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-xl-3 col-sm-6">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-uppercase font-weight-bold">Durée Totale</p>
                <h5 class="font-weight-bolder mb-0">
                  {{ duree_totale_formatee }}
                </h5>
                <p class="mb-0">
                  <span class="text-success text-sm font-weight-bolder">{{ duree_moyenne }} min</span>
                  moyenne
                </p>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle">
                <i class="fas fa-clock text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  {# Graphiques et visualisations #}
  <div class="row mt-4">
    {# Distribution par catégories #}
    <div class="col-lg-8 col-md-6 mb-md-0 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <div class="row">
            <div class="col-lg-6 col-7">
              <h6>Distribution des Séances par Catégorie</h6>
              <p class="text-sm mb-0">
                <i class="fa fa-check text-info" aria-hidden="true"></i>
                <span class="font-weight-bold ms-1">{{ total_seances }} séances</span> au total
              </p>
            </div>
          </div>
        </div>
        <div class="card-body px-0 pb-2">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Catégorie</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Séances</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Pourcentage</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Durée totale</th>
                </tr>
              </thead>
              <tbody>
                {% for categorie in categories_avec_stats %}
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div>
                        {% if categorie.iconUrl %}
                          <img src="{{ categorie.iconUrl }}" class="avatar avatar-sm me-3" alt="{{ categorie.nom }}" style="object-fit: cover;">
                        {% else %}
                          <div class="avatar avatar-sm bg-gradient-dark me-3 d-flex align-items-center justify-content-center">
                            <i class="fas fa-spa text-white text-xs"></i>
                          </div>
                        {% endif %}
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">{{ categorie.nom }}</h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="progress-wrapper w-75 mx-auto">
                      <div class="progress-info">
                        <div class="progress-percentage">
                          <span class="text-xs font-weight-bold">{{ categorie.nbSeances }}</span>
                        </div>
                      </div>
                      <div class="progress">
                        <div class="progress-bar bg-gradient-{{ cycle(['info', 'success', 'warning', 'danger', 'primary'], loop.index0) }}" 
                             role="progressbar" 
                             aria-valuenow="{{ categorie.pourcentage }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100" 
                             style="width: {{ categorie.pourcentage }}%;">
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="align-middle text-center text-sm">
                    <span class="text-xs font-weight-bold">{{ categorie.pourcentage }}%</span>
                  </td>
                  <td class="align-middle text-center">
                    <span class="text-xs font-weight-bold">{{ categorie.dureeTotaleFormatee }}</span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    {# Statistiques par type et niveau #}
    <div class="col-lg-4 col-md-6">
      <div class="card h-100">
        <div class="card-header pb-0">
          <h6>Statistiques par Type & Niveau</h6>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            {# Type de fichiers #}
            <div class="mb-4">
              <h6 class="text-sm mb-0">Type de fichiers</h6>
              <div class="row mt-2">
                <div class="col-6 text-center">
                  <div class="icon icon-shape bg-gradient-info shadow-info text-center rounded-circle mb-2" style="width: 40px; height: 40px; margin: 0 auto;">
                    <i class="fas fa-music text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                  <h5 class="font-weight-bolder mb-0">{{ stats_type.audio }}</h5>
                  <p class="text-sm mb-0">Audio</p>
                  <span class="text-xs font-weight-bold">{{ stats_type.pourcentage_audio }}%</span>
                </div>
                <div class="col-6 text-center">
                  <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle mb-2" style="width: 40px; height: 40px; margin: 0 auto;">
                    <i class="fas fa-video text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                  <h5 class="font-weight-bolder mb-0">{{ stats_type.video }}</h5>
                  <p class="text-sm mb-0">Vidéo</p>
                  <span class="text-xs font-weight-bold">{{ stats_type.pourcentage_video }}%</span>
                </div>
              </div>
            </div>
            
            {# Niveau des séances #}
            <div class="mt-4">
              <h6 class="text-sm mb-0">Répartition par niveau</h6>
              <div class="row mt-2">
                <div class="col-4 text-center">
                  <div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle mb-2" style="width: 40px; height: 40px; margin: 0 auto;">
                    <i class="fas fa-seedling text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                  <h5 class="font-weight-bolder mb-0">{{ stats_niveau.debutant }}</h5>
                  <p class="text-xs mb-0">Débutant</p>
                  <span class="text-xs font-weight-bold">{{ stats_niveau.pourcentage_debutant }}%</span>
                </div>
                <div class="col-4 text-center">
                  <div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle mb-2" style="width: 40px; height: 40px; margin: 0 auto;">
                    <i class="fas fa-tree text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                  <h5 class="font-weight-bolder mb-0">{{ stats_niveau.intermediaire }}</h5>
                  <p class="text-xs mb-0">Intermédiaire</p>
                  <span class="text-xs font-weight-bold">{{ stats_niveau.pourcentage_intermediaire }}%</span>
                </div>
                <div class="col-4 text-center">
                  <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle mb-2" style="width: 40px; height: 40px; margin: 0 auto;">
                    <i class="fas fa-mountain text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                  <h5 class="font-weight-bolder mb-0">{{ stats_niveau.avance }}</h5>
                  <p class="text-xs mb-0">Avancé</p>
                  <span class="text-xs font-weight-bold">{{ stats_niveau.pourcentage_avance }}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  {# Graphiques d'évolution #}
  <div class="row mt-4">
    {# Évolution mensuelle #}
    <div class="col-lg-6 col-md-6 mb-md-0 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <div class="row">
            <div class="col-lg-6 col-7">
              <h6>Évolution Mensuelle</h6>
              <p class="text-sm mb-0">
                <i class="fa fa-arrow-up text-success" aria-hidden="true"></i>
                <span class="font-weight-bold ms-1">Nouvelles séances</span> par mois
              </p>
            </div>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="evolutionChart" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>
    
    {# Top 5 des catégories #}
    <div class="col-lg-6 col-md-6">
      <div class="card">
        <div class="card-header pb-0">
          <h6>Top 5 Catégories Populaires</h6>
          <p class="text-sm mb-0">
            <i class="fa fa-fire text-warning" aria-hidden="true"></i>
            Catégories avec le plus de séances
          </p>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="topCategoriesChart" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  {# Dernières activités #}
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header pb-0">
          <h6>Activités Récentes</h6>
          <p class="text-sm mb-0">
            <i class="fa fa-history text-info" aria-hidden="true"></i>
            Dernières séances ajoutées
          </p>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Séance</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Catégorie</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Type & Durée</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Niveau</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Date création</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Statut</th>
                </tr>
              </thead>
              <tbody>
                {% for seance in dernieres_seances %}
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div>
                        {% if seance.typeFichier == 'audio' %}
                          <div class="avatar avatar-sm bg-gradient-info me-3 d-flex align-items-center justify-content-center">
                            <i class="fas fa-music text-white text-xs"></i>
                          </div>
                        {% else %}
                          <div class="avatar avatar-sm bg-gradient-danger me-3 d-flex align-items-center justify-content-center">
                            <i class="fas fa-video text-white text-xs"></i>
                          </div>
                        {% endif %}
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">{{ seance.titre }}</h6>
                        <p class="text-xs text-secondary mb-0">
                          {{ seance.description|slice(0, 50) }}...
                        </p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-sm font-weight-bold mb-0">
                      <i class="fas fa-spa me-1"></i>
                      {{ seance.categorie.nom }}
                    </p>
                  </td>
                  <td class="align-middle text-center">
                    <span class="badge badge-sm bg-gradient-{{ seance.typeFichier == 'audio' ? 'info' : 'danger' }}">
                      {{ seance.typeFichier|capitalize }}
                    </span>
                    <p class="text-xs text-secondary mb-0 mt-1">
                      {{ seance.getDureeFormatee() }}
                    </p>
                  </td>
                  <td class="align-middle text-center">
                    <span class="badge badge-sm 
                      {% if seance.niveau == 'débutant' %}bg-gradient-success
                      {% elseif seance.niveau == 'intermédiaire' %}bg-gradient-warning
                      {% else %}bg-gradient-danger{% endif %}">
                      {{ seance.niveau|capitalize }}
                    </span>
                  </td>
                  <td class="align-middle text-center">
                    <span class="text-secondary text-xs font-weight-bold">
                      {{ seance.createdAt|date('d/m/Y') }}
                    </span>
                    <p class="text-xs text-secondary mb-0">
                      {{ seance.createdAt|date('H:i') }}
                    </p>
                  </td>
                  <td class="align-middle text-center">
                    <span class="badge badge-sm bg-gradient-{{ seance.isActive ? 'success' : 'secondary' }}">
                      {{ seance.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="6" class="text-center py-4">
                    <div class="avatar avatar-xl bg-gradient-info rounded-circle mx-auto mb-3">
                      <i class="fas fa-headphones text-white text-2xl"></i>
                    </div>
                    <h6 class="text-gradient text-info mb-0">Aucune séance récente</h6>
                    <p class="text-sm mb-0">Commencez par créer des séances de méditation</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // Graphique d'évolution mensuelle
  const evolutionCtx = document.getElementById('evolutionChart').getContext('2d');
  const evolutionChart = new Chart(evolutionCtx, {
    type: 'line',
    data: {
      labels: {{ evolution_labels|json_encode|raw }},
      datasets: [{
        label: 'Nouvelles séances',
        data: {{ evolution_data|json_encode|raw }},
        borderColor: '#4CAF50',
        backgroundColor: 'rgba(76, 175, 80, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      }
    }
  });
  
  // Graphique Top 5 catégories
  const topCatCtx = document.getElementById('topCategoriesChart').getContext('2d');
  const topCategoriesChart = new Chart(topCatCtx, {
    type: 'doughnut',
    data: {
      labels: {{ top_categories_labels|json_encode|raw }},
      datasets: [{
        data: {{ top_categories_data|json_encode|raw }},
        backgroundColor: [
          '#4CAF50',
          '#2196F3',
          '#FF9800',
          '#F44336',
          '#9C27B0',
          '#00BCD4',
          '#FFEB3B',
          '#795548'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'right',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.label || '';
              if (label) {
                label += ': ';
              }
              label += context.raw + ' séances';
              return label;
            }
          }
        }
      }
    }
  });
  
  // Animation des compteurs
  function animateCounter(element, target, duration) {
    let start = 0;
    const increment = target / (duration / 16);
    const timer = setInterval(() => {
      start += increment;
      if (start >= target) {
        element.textContent = target;
        clearInterval(timer);
      } else {
        element.textContent = Math.floor(start);
      }
    }, 16);
  }
  
  // Animer les compteurs principaux
  const counters = document.querySelectorAll('.font-weight-bolder.mb-0');
  counters.forEach(counter => {
    const target = parseInt(counter.textContent.replace(/\D/g, ''));
    if (!isNaN(target) && target > 0) {
      counter.textContent = '0';
      animateCounter(counter, target, 2000);
    }
  });
});
</script>
{% endblock %}