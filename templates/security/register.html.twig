{# templates/security/register.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Inscription - UniMind{% endblock %}

{% block unauthenticated_body %}
<section>
  <div class="page-header min-vh-100">
    <div class="container">
      <div class="row">

        {# ==== Colonne gauche : Formulaire (mêmes largeurs que le login) ==== #}
        <div class="col-xl-4 col-lg-5 col-md-7 d-flex flex-column mx-lg-0 mx-auto">
          <div class="card card-plain">
            <div class="card-header pb-0 text-start">
              <h4 class="font-weight-bolder">Inscription</h4>
              <p class="mb-0">Créez votre compte UniMind</p>
            </div>

            {# Flashs #}
            {% for message in app.flashes('success') %}
              <div class="alert alert-success alert-dismissible fade show mx-4 mt-3" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
              </div>
            {% endfor %}
            {% for message in app.flashes('error') %}
              <div class="alert alert-danger alert-dismissible fade show mx-4 mt-3" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
              </div>
            {% endfor %}

            <div class="card-body">

              {# ===== Étape 1 : Sélection du rôle (mêmes boutons, clean) ===== #}
              <div id="roleSelectionStep" class="step" {% if registrationForm.role.vars.value is not empty %}style="display:none;"{% endif %}>
                <h6 class="text-dark mb-4">Sélectionnez votre rôle :</h6>

                <div class="d-grid gap-3">
                  <button type="button" class="btn btn-outline-primary btn-lg role-select-btn text-start p-3" data-role="Etudiant">
                    <div class="d-flex align-items-start">
                      <i class="fas fa-user-graduate me-3 mt-1"></i>
                      <div>
                        <strong class="d-block">Étudiant</strong>
                        <span class="text-sm text-muted">Je suis étudiant et je cherche du soutien psychologique</span>
                      </div>
                    </div>
                  </button>

                  <button type="button" class="btn btn-outline-success btn-lg role-select-btn text-start p-3" data-role="Psychologue">
                    <div class="d-flex align-items-start">
                      <i class="fas fa-heartbeat me-3 mt-1"></i>
                      <div>
                        <strong class="d-block">Psychologue</strong>
                        <span class="text-sm text-muted">Je suis psychologue et je veux proposer mes services</span>
                      </div>
                    </div>
                  </button>

                  <button type="button" class="btn btn-outline-warning btn-lg role-select-btn text-start p-3" data-role="Responsable Etudiant">
                    <div class="d-flex align-items-start">
                      <i class="fas fa-user-tie me-3 mt-1"></i>
                      <div>
                        <strong class="d-block">Responsable Étudiant</strong>
                        <span class="text-sm text-muted">Je suis responsable d'étudiants dans un établissement</span>
                      </div>
                    </div>
                  </button>
                </div>

                <p class="text-sm text-muted mt-4">
                  <i class="fas fa-info-circle text-info me-1"></i>
                  Les comptes administrateur ne sont pas accessibles via l'inscription publique.
                </p>
              </div>

              {# ===== Étape 2 : Formulaire ===== #}
              <div id="registrationFormStep" class="step" {% if registrationForm.role.vars.value is empty %}style="display:none;"{% endif %}>
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h6 class="text-dark mb-0">Inscription - <span id="selectedRoleLabel">{{ registrationForm.role.vars.value }}</span></h6>
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="goBackToRoleSelection()">
                    <i class="fas fa-arrow-left me-1"></i> Changer de rôle
                  </button>
                </div>

                {{ form_start(registrationForm, {'attr': {'class': 'needs-validation', 'novalidate': 'novalidate', 'id': 'registrationForm'}}) }}

                  {# Radios réels du champ role (cachés mais postés) #}
                  <div class="d-none">
                    {{ form_widget(registrationForm.role) }}
                  </div>

                  {# Erreurs globales #}
                  {% if registrationForm.vars.errors|length > 0 %}
                    <div class="alert alert-danger">
                      {% for error in registrationForm.vars.errors %}
                        <p class="mb-0">{{ error.message }}</p>
                      {% endfor %}
                    </div>
                  {% endif %}

                  {# Infos personnelles #}
                  <h6 class="text-dark mb-3"><i class="fas fa-user-circle me-2"></i>Informations personnelles</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        {{ form_label(registrationForm.nom, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.nom, {'attr': {'class': 'form-control form-control-lg'}}) }}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        {{ form_label(registrationForm.prenom, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.prenom, {'attr': {'class': 'form-control form-control-lg'}}) }}
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        {{ form_label(registrationForm.email, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.email, {'attr': {'class': 'form-control form-control-lg'}}) }}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        {{ form_label(registrationForm.cin, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.cin, {'attr': {'class': 'form-control form-control-lg'}}) }}
                      </div>
                    </div>
                  </div>

                  {# Étudiant #}
                  <div id="studentFields" class="role-fields" style="display: {% if registrationForm.role.vars.value == 'Etudiant' %}block{% else %}none{% endif %};">
                    <hr class="horizontal dark">
                    <h6 class="text-dark mb-3"><i class="fas fa-graduation-cap me-2"></i>Informations étudiant</h6>
                    <div class="mb-3">
                      {{ form_label(registrationForm.identifiant, null, {'label_attr': {'class': 'form-label'}}) }}
                      {{ form_widget(registrationForm.identifiant, {'attr': {'class': 'form-control form-control-lg'}}) }}
                    </div>
                    <div class="mb-3">
                      {{ form_label(registrationForm.nom_etablissement, null, {'label_attr': {'class': 'form-label'}}) }}
                      {{ form_widget(registrationForm.nom_etablissement, {'attr': {'class': 'form-control form-control-lg'}}) }}
                    </div>
                  </div>

                  {# Psychologue #}
                  <div id="psychologueFields" class="role-fields" style="display: {% if registrationForm.role.vars.value == 'Psychologue' %}block{% else %}none{% endif %};">
                    <hr class="horizontal dark">
                    <h6 class="text-dark mb-3"><i class="fas fa-heartbeat me-2"></i>Informations psychologue</h6>
                    <div class="mb-3">
                      {{ form_label(registrationForm.specialite, null, {'label_attr': {'class': 'form-label'}}) }}
                      {{ form_widget(registrationForm.specialite, {'attr': {'class': 'form-control form-control-lg'}}) }}
                    </div>
                    <div class="mb-3">
                      {{ form_label(registrationForm.adresse, null, {'label_attr': {'class': 'form-label'}}) }}
                      {{ form_widget(registrationForm.adresse, {'attr': {'class': 'form-control form-control-lg'}}) }}
                    </div>
                    <div class="mb-3">
                      {{ form_label(registrationForm.telephone, null, {'label_attr': {'class': 'form-label'}}) }}
                      {{ form_widget(registrationForm.telephone, {'attr': {'class': 'form-control form-control-lg'}}) }}
                    </div>
                  </div>

                  {# Responsable #}
                  <div id="responsableFields" class="role-fields" style="display: {% if registrationForm.role.vars.value == 'Responsable Etudiant' %}block{% else %}none{% endif %};">
                    <hr class="horizontal dark">
                    <h6 class="text-dark mb-3"><i class="fas fa-user-tie me-2"></i>Informations responsable</h6>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          {{ form_label(registrationForm.poste, null, {'label_attr': {'class': 'form-label'}}) }}
                          {{ form_widget(registrationForm.poste, {'attr': {'class': 'form-control form-control-lg'}}) }}
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          {{ form_label(registrationForm.etablissement, null, {'label_attr': {'class': 'form-label'}}) }}
                          {{ form_widget(registrationForm.etablissement, {'attr': {'class': 'form-control form-control-lg'}}) }}
                        </div>
                      </div>
                    </div>
                  </div>

                  {# Sécurité #}
                  <hr class="horizontal dark">
                  <h6 class="text-dark mb-3"><i class="fas fa-lock me-2"></i>Sécurité du compte</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        {{ form_label(registrationForm.plainPassword.first, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.plainPassword.first, {'attr': {'class': 'form-control form-control-lg'}}) }}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        {{ form_label(registrationForm.plainPassword.second, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.plainPassword.second, {'attr': {'class': 'form-control form-control-lg'}}) }}
                      </div>
                    </div>
                  </div>

                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="terms" required>
                    <label class="form-check-label" for="terms">
                      <i class="fas fa-file-contract me-1"></i>
                      J'accepte les conditions d'utilisation et la politique de confidentialité
                    </label>
                  </div>

                  <div class="text-center">
                    <button type="submit" class="btn btn-lg btn-primary w-100 mt-2">
                      <i class="fas fa-user-plus me-2"></i>Créer mon compte
                    </button>
                  </div>

                {{ form_end(registrationForm) }}

              </div>
            </div>

            {# Pied : lien "Se connecter" (comme le login) #}
            <div class="card-footer text-center pt-0 px-lg-2 px-1">
              <p class="mb-4 text-sm mx-auto">
                Vous avez déjà un compte ?
                <a href="{{ path('app_login') }}" class="text-primary text-gradient fw-bold">
                  Se connecter
                </a>
              </p>
            </div>
          </div>
        </div>

        {# ==== Colonne droite : EXACTEMENT le même style que la page de connexion ==== #}
        <div class="col-6 d-lg-flex d-none h-100 my-auto pe-0 position-absolute top-0 end-0 text-center justify-content-center flex-column">
          <div class="position-relative bg-gradient-primary h-100 m-3 px-7 border-radius-lg d-flex flex-column justify-content-center overflow-hidden"
               style="background-image: url('https://images.unsplash.com/photo-1559757175-0eb30cd8c063?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1600&q=80'); background-size: cover;">
            <span class="mask bg-gradient-primary opacity-6"></span>
            <h4 class="mt-5 text-white font-weight-bolder position-relative">"La santé mentale n'est pas une destination, mais un voyage"</h4>
            <p class="text-white position-relative">Prendre soin de son bien-être mental est essentiel pour une vie équilibrée et épanouissante.</p>
          </div>
        </div>

      </div>
    </div>
  </div>
</section>

{# ===== JS : Sélection rôle + champs conditionnels ===== #}
<script>
  const roleRadios = document.querySelectorAll('input[name="{{ registrationForm.role.vars.full_name }}"]');
  const selectedRoleFromServer = {{ registrationForm.role.vars.value|json_encode|raw }} || '';
  const form = document.getElementById('registrationForm');

  function hideAllRoleBlocks() {
    document.querySelectorAll('.role-fields').forEach(b => b.style.display = 'none');
  }
  function applyRoleUI(role) {
    hideAllRoleBlocks();
    if (role === 'Etudiant') document.getElementById('studentFields').style.display = 'block';
    else if (role === 'Psychologue') document.getElementById('psychologueFields').style.display = 'block';
    else if (role === 'Responsable Etudiant') document.getElementById('responsableFields').style.display = 'block';
  }
  function selectRole(role) {
    roleRadios.forEach(r => r.checked = (r.value === role));
    document.getElementById('selectedRoleLabel').textContent = role;
    applyRoleUI(role);
    document.getElementById('roleSelectionStep').style.display = 'none';
    document.getElementById('registrationFormStep').style.display = 'block';
  }
  if (selectedRoleFromServer) {
    roleRadios.forEach(r => r.checked = (r.value === selectedRoleFromServer));
    document.getElementById('roleSelectionStep').style.display = 'none';
    document.getElementById('registrationFormStep').style.display = 'block';
    document.getElementById('selectedRoleLabel').textContent = selectedRoleFromServer;
    applyRoleUI(selectedRoleFromServer);
  }
  document.querySelectorAll('.role-select-btn').forEach(btn => {
    btn.addEventListener('click', function() { selectRole(this.dataset.role); });
  });
  function goBackToRoleSelection() {
    document.getElementById('roleSelectionStep').style.display = 'block';
    document.getElementById('registrationFormStep').style.display = 'none';
    roleRadios.forEach(r => r.checked = false);
    hideAllRoleBlocks();
  }
  form?.addEventListener('submit', function(e) {
    const anyChecked = Array.from(roleRadios).some(r => r.checked);
    if (!anyChecked) {
      e.preventDefault();
      document.getElementById('roleSelectionStep').style.display = 'block';
      document.getElementById('registrationFormStep').style.display = 'none';
      alert('Veuillez sélectionner un rôle.');
      return false;
    }
  });
</script>
{% endblock %}