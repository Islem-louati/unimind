{# templates/security/face_login.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Connexion par reconnaissance faciale - UniMind{% endblock %}

{% block unauthenticated_body %}
<section>
    <div class="page-header min-vh-100">
        <div class="container">
            <div class="row">
                {# Colonne formulaire #}
                <div class="col-xl-4 col-lg-5 col-md-7 d-flex flex-column mx-lg-0 mx-auto">
                    <div class="card card-plain">
                        <div class="card-header pb-0 text-start">
                            <h4 class="font-weight-bolder">
                                <i class="fas fa-camera me-2 text-primary"></i>
                                Connexion par visage
                            </h4>
                            <p class="mb-0">Connectez-vous avec votre visage en 3 secondes</p>
                        </div>

                        {# Flash messages #}
                        {% for message in app.flashes('error') %}
                            <div class="alert alert-danger alert-dismissible fade show mx-4 mt-3" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}

                        <div class="card-body">

                            {# === √âTAPE 1 : Saisie de l'email === #}
                            <div id="step-email">
                                <p class="text-sm text-muted mb-3">
                                    <i class="fas fa-info-circle text-info me-1"></i>
                                    Entrez votre email pour que le syst√®me retrouve votre photo de profil.
                                </p>

                                <div class="mb-3">
                                    <label class="form-label">Adresse email</label>
                                    <input type="email" id="userEmail" class="form-control form-control-lg"
                                           placeholder="votre@email.com" required>
                                </div>

                                <div id="emailError" class="alert alert-danger d-none"></div>

                                <div class="text-center">
                                    <button type="button" id="btnPrepare" class="btn btn-primary btn-lg w-100 mt-2">
                                        <i class="fas fa-arrow-right me-2"></i>
                                        Continuer
                                    </button>
                                </div>
                            </div>

                            {# === √âTAPE 2 : Capture webcam === #}
                            <div id="step-camera" style="display:none;">
                                <div class="text-center mb-3">
                                    <p class="text-sm text-muted">
                                        Bonjour <strong id="userName"></strong> !
                                        Positionnez votre visage dans le cadre et cliquez sur "V√©rifier".
                                    </p>
                                </div>

                                {# Vid√©o webcam #}
                                <div class="position-relative text-center mb-3">
                                    <video id="webcam" autoplay playsinline muted
                                           style="width:100%; border-radius:12px; border:3px solid #5e72e4; transform: scaleX(-1);">
                                    </video>
                                    {# Overlay guide visage #}
                                    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
                                                width:160px; height:200px; border:3px dashed rgba(94,114,228,0.8);
                                                border-radius:50%; pointer-events:none;"></div>
                                    <canvas id="snapshot" style="display:none;"></canvas>
                                </div>

                                {# Indicateur de statut #}
                                <div id="statusBar" class="alert alert-info text-center mb-3" style="display:none;"></div>

                                <div id="cameraError" class="alert alert-danger d-none"></div>

                                {# R√©sultat confiance #}
                                <div id="confidenceBar" style="display:none;" class="mb-3">
                                    <label class="form-label text-sm">Niveau de confiance</label>
                                    <div class="progress" style="height:20px; border-radius:10px;">
                                        <div id="confidenceProgress" class="progress-bar" role="progressbar"
                                             style="width:0%; border-radius:10px; transition: width 1s ease;">
                                        </div>
                                    </div>
                                    <small id="confidenceText" class="text-muted"></small>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="button" id="btnCapture" class="btn btn-primary btn-lg">
                                        <i class="fas fa-camera me-2"></i>
                                        V√©rifier mon identit√©
                                    </button>
                                    <button type="button" id="btnRetry" class="btn btn-outline-secondary" style="display:none;">
                                        <i class="fas fa-redo me-2"></i>
                                        R√©essayer
                                    </button>
                                    <button type="button" id="btnBack" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-arrow-left me-1"></i>
                                        Changer d'email
                                    </button>
                                </div>
                            </div>

                            {# === √âTAPE 3 : Succ√®s === #}
                            <div id="step-success" style="display:none;" class="text-center py-4">
                                <div class="mb-3">
                                    <i class="fas fa-check-circle text-success" style="font-size:4rem;"></i>
                                </div>
                                <h5 class="text-success">Identit√© v√©rifi√©e !</h5>
                                <p class="text-muted">Redirection en cours...</p>
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>

                        </div>

                        <div class="card-footer text-center pt-0 px-lg-2 px-1">
                            <p class="mb-2 text-sm mx-auto">
                                Pr√©f√©rez la connexion classique ?
                                <a href="{{ path('app_login') }}" class="text-primary text-gradient fw-bold">
                                    Se connecter
                                </a>
                            </p>
                            <p class="mb-0 text-sm mx-auto">
                                Pas encore de compte ?
                                <a href="{{ path('app_register') }}" class="text-primary text-gradient fw-bold">
                                    S'inscrire
                                </a>
                            </p>
                        </div>
                    </div>
                </div>

                {# Colonne droite d√©corative #}
                <div class="col-6 d-lg-flex d-none h-100 my-auto pe-0 position-absolute top-0 end-0 text-center justify-content-center flex-column">
                    <div class="position-relative bg-gradient-primary h-100 m-3 px-7 border-radius-lg d-flex flex-column justify-content-center overflow-hidden"
                         style="background-image: url('https://images.unsplash.com/photo-1559757175-0eb30cd8c063?auto=format&fit=crop&w=1600&q=80');
                                background-size: cover;">
                        <span class="mask bg-gradient-primary opacity-6"></span>
                        <i class="fas fa-user-circle position-relative text-white mb-4" style="font-size:5rem;"></i>
                        <h4 class="mt-2 text-white font-weight-bolder position-relative">Connexion s√©curis√©e</h4>
                        <p class="text-white position-relative">Notre syst√®me de reconnaissance faciale IA identifie votre visage en moins de 3 secondes.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

<script>
    // ===== VARIABLES GLOBALES =====
    let stream = null;
    let userId = null;
    let userPhoto = null;
    let loginToken = null;

    const stepEmail = document.getElementById('step-email');
    const stepCamera = document.getElementById('step-camera');
    const stepSuccess = document.getElementById('step-success');
    const webcam = document.getElementById('webcam');
    const canvas = document.getElementById('snapshot');
    const statusBar = document.getElementById('statusBar');
    const emailError = document.getElementById('emailError');
    const cameraError = document.getElementById('cameraError');

    // ===== √âTAPE 1 : Pr√©parer la connexion (trouver l'utilisateur) =====
    document.getElementById('btnPrepare').addEventListener('click', async () => {
        const email = document.getElementById('userEmail').value.trim();
        emailError.classList.add('d-none');

        if (!email || !email.includes('@')) {
            emailError.textContent = 'Veuillez entrer un email valide.';
            emailError.classList.remove('d-none');
            return;
        }

        const btn = document.getElementById('btnPrepare');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Recherche...';

        try {
            const response = await fetch('{{ path("api_face_login_prepare") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });

            const data = await response.json();

            if (!response.ok || data.error) {
                emailError.textContent = data.error || 'Erreur lors de la recherche.';
                emailError.classList.remove('d-none');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-arrow-right me-2"></i>Continuer';
                return;
            }

            // Stocker les infos utilisateur
            userId = data.user_id;
            userPhoto = data.photo;
            document.getElementById('userName').textContent = data.name;

            // Passer √† l'√©tape cam√©ra
            stepEmail.style.display = 'none';
            stepCamera.style.display = 'block';
            await startCamera();

        } catch (err) {
            emailError.textContent = 'Erreur r√©seau. V√©rifiez votre connexion.';
            emailError.classList.remove('d-none');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-arrow-right me-2"></i>Continuer';
        }
    });

    // Permettre la touche Entr√©e sur l'email
    document.getElementById('userEmail').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') document.getElementById('btnPrepare').click();
    });

    // ===== D√âMARRER LA CAM√âRA =====
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 480, facingMode: 'user' }
            });
            webcam.srcObject = stream;
            showStatus('üì∑ Cam√©ra pr√™te. Positionnez votre visage dans le cadre.', 'info');
        } catch (err) {
            cameraError.textContent = 'Impossible d\'acc√©der √† la cam√©ra. Autorisez l\'acc√®s dans votre navigateur.';
            cameraError.classList.remove('d-none');
        }
    }

    // ===== √âTAPE 2 : Capturer et v√©rifier le visage =====
    document.getElementById('btnCapture').addEventListener('click', async () => {
        if (!stream) {
            cameraError.textContent = 'Cam√©ra non disponible.';
            cameraError.classList.remove('d-none');
            return;
        }

        const btn = document.getElementById('btnCapture');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyse en cours...';
        showStatus('üîç Analyse de votre visage en cours...', 'info');
        cameraError.classList.add('d-none');

        // Capturer une frame de la vid√©o
        canvas.width = webcam.videoWidth;
        canvas.height = webcam.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(webcam, 0, 0);

        // Convertir en base64
        const capturedImage = canvas.toDataURL('image/jpeg', 0.9);

        try {
            const response = await fetch('{{ path("api_face_login_verify") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    captured_image: capturedImage,
                    user_photo: userPhoto
                })
            });

            const data = await response.json();

            // Afficher la barre de confiance
            showConfidence(data.confidence || 0, data.success || false);

            if (data.success) {
                // ‚úÖ Succ√®s !
                stopCamera();
                showStatus('‚úÖ Identit√© v√©rifi√©e ! Connexion en cours...', 'success');
                loginToken = data.login_token;

                setTimeout(() => {
                    stepCamera.style.display = 'none';
                    stepSuccess.style.display = 'block';
                    // Rediriger vers la confirmation
                    window.location.href = data.redirect;
                }, 1500);

            } else {
                // ‚ùå √âchec
                showStatus('‚ùå ' + (data.message || 'Visage non reconnu. R√©essayez.'), 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-camera me-2"></i>V√©rifier mon identit√©';
                document.getElementById('btnRetry').style.display = 'block';
            }

        } catch (err) {
            showStatus('‚ùå Erreur de connexion au serveur.', 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-camera me-2"></i>V√©rifier mon identit√©';
        }
    });

    // ===== R√âESSAYER =====
    document.getElementById('btnRetry').addEventListener('click', () => {
        document.getElementById('btnRetry').style.display = 'none';
        document.getElementById('btnCapture').disabled = false;
        document.getElementById('btnCapture').innerHTML = '<i class="fas fa-camera me-2"></i>V√©rifier mon identit√©';
        document.getElementById('confidenceBar').style.display = 'none';
        showStatus('üì∑ R√©essayez. Assurez-vous d\'√™tre bien √©clair√© et face √† la cam√©ra.', 'info');
    });

    // ===== RETOUR √Ä L'EMAIL =====
    document.getElementById('btnBack').addEventListener('click', () => {
        stopCamera();
        stepCamera.style.display = 'none';
        stepEmail.style.display = 'block';
        document.getElementById('confidenceBar').style.display = 'none';
        statusBar.style.display = 'none';
        document.getElementById('btnPrepare').disabled = false;
        document.getElementById('btnPrepare').innerHTML = '<i class="fas fa-arrow-right me-2"></i>Continuer';
    });

    // ===== FONCTIONS UTILITAIRES =====
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    function showStatus(message, type) {
        statusBar.className = `alert alert-${type} text-center mb-3`;
        statusBar.textContent = message;
        statusBar.style.display = 'block';
    }

    function showConfidence(confidence, isSuccess) {
        const bar = document.getElementById('confidenceBar');
        const progress = document.getElementById('confidenceProgress');
        const text = document.getElementById('confidenceText');
        const percent = Math.round(confidence * 100);

        bar.style.display = 'block';
        progress.style.width = percent + '%';
        progress.textContent = percent + '%';

        if (isSuccess) {
            progress.className = 'progress-bar bg-success';
            text.textContent = `Confiance: ${percent}% ‚úÖ`;
        } else if (percent > 40) {
            progress.className = 'progress-bar bg-warning';
            text.textContent = `Confiance insuffisante: ${percent}% (minimum 50%)`;
        } else {
            progress.className = 'progress-bar bg-danger';
            text.textContent = `Visage non reconnu: ${percent}%`;
        }
    }

    // Arr√™ter la cam√©ra si on quitte la page
    window.addEventListener('beforeunload', stopCamera);
</script>
{% endblock %}
